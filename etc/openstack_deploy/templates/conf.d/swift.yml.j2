#jinja2: lstrip_blocks: True
# {{ ansible_managed }}
---
# The nodes that will be running the Swift services
{% if 'swift' in onpc_services_list %}
swift-proxy_hosts:
{% for h in infrastructure_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
    container_vars:
      swift_proxy_vars:
        limit_container_types: swift_proxy
        read_affinity: "r{{ loop.index }}=100"
        write_affinity: "r{{ loop.index }}"
        write_affinity_node_count: "2 * replicas"
{% endfor %}

swift_hosts:
{% for h in swift_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
    container_vars:
      swift_vars:
        mount_point: /srv/node
        limit_container_types: swift
        zone: {{ loop.index }}
        region: 1
        weight: 100
        drives:
{% for p in onpc_partitions_list %}
  {% set device = '' %}
  {% if p.name | regex_search('^swift') %}
    {%- set device = hostvars[h.hostname]['ansible_mounts'] | selectattr('mount', 'equalto', p.mountpoint) | regex_replace('\\/$', '') | map(attribute='device') | join %}
          - name: {{ device }}
  {% endif %}
{% endfor %}
{% endfor %}
{% endif %}