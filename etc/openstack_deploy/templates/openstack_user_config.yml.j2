# {{ ansible_managed }}
---
cidr_networks: &cidr_networks
  container: {{ management_network }}
  tunnel: {{ tunnel_network }}
  storage: {{ storage_network }}
{% if 'octavia' in onpc_services_list %}
  lbaas: {{ lbaas_network }}
{% endif %}

used_ips:
{% for ip_or_range in reserved_ips %}
  - {{ ip_or_range }}
{% endfor %}

global_overrides:
  internal_lb_vip_address: {{ internal_vip_address }}
  external_lb_vip_address: {{ external_vip_address }}
  management_bridge: "br-mgmt"
  tunnel_bridge: "br-vxlan"
  storage_bridge: "br-storage"
  lb_name: haproxy
  provider_networks:
    - network:
        container_bridge: "br-mgmt"
        container_interface: "eth1"
        container_type: "veth"
        ip_from_q: "management"
        is_container_address: true
        is_ssh_address: true
        type: "raw"
        group_binds:
          - all_containers
          - hosts
    - network:
        container_bridge: "br-storage"
        container_interface: "eth2"
        container_type: "veth"
        container_mtu: "9000"
        ip_from_q: "storage"
        type: "raw"
        group_binds:
          - glance_api
          - cinder_api
          - cinder_volume
          - nova_compute
{% if 'swift' in onpc_services_list %}
          - swift_proxy
{% elif 'ceph' in onpc_services_list %}
          - ceph_osd
{% endif %}
    - network:
        container_bridge: "br-vxlan"
        container_type: "veth"
        container_interface: "eth10"
        container_mtu: "9000"
        ip_from_q: "tunnel"
        type: "vxlan"
        range: "1:1000"
        net_name: "vxlan"
        group_binds:
          - neutron_linuxbridge_agent
    - network:
        container_bridge: "br-vlan"
        container_type: "veth"
        container_interface: "eth11"
        type: "vlan"
        range: "1:1"
        net_name: "vlan"
        group_binds:
          - neutron_linuxbridge_agent
## Not used anymore since rocky
#   - network:
#       container_bridge: "br-vlan"
#       container_type: "veth"
#       container_interface: "eth12"
#       host_bind_override: "eth12"
#       type: "flat"
#       net_name: "flat"
#       group_binds:
#         - neutron_linuxbridge_agent
{% if 'octavia' in onpc_services_list %}
    - network:
        container_bridge: "br-lbaas"
        container_type: "veth"
        container_interface: "eth14"
        host_bind_override: "eth14"
        ip_from_q: "lbaas"
        type: "flat"
        net_name: "lbaas"
        group_binds:
          - neutron_linuxbridge_agent
          - octavia-worker
          - octavia-housekeeping
          - octavia-health-manager
{% endif %}
{% if 'swift' in onpc_services_list %}
  swift:
    part_power: 8
    repl_number: 3
    min_part_hours: 1
{%- raw %}
    storage_network: "{{ (container_tech != 'nspawn') | ternary('br-storage', ansible_default_ipv4['alias']) }}"
    replication_network: "{{ (container_tech != 'nspawn') | ternary('br-storage', ansible_default_ipv4['alias']) }}"
{% endraw %}
    statsd_host: localhost
    statsd_port: 8125
{%- raw %}
    statsd_metric_prefix: "{{ inventory_hostname }}.swift"
{% endraw %}
    storage_policies:
      - policy:
          name: default
          index: 0
          default: True
{% endif %} 

# Infrastructure (memcached, galera, rabbitmq, ...) hosts
_infrastructure_hosts: &infrastructure_hosts
{% for h in infrastructure_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
    container_vars:
      # Optional | container_tech for a target host, default is "lxc".
      container_tech: "{{ onpc_bootstrap_container_tech }}"
{% endfor %}

# The compute hypervisor hosts
compute_hosts: &compute_hosts
{% for h in compute_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
{% endfor %}

# The server(s) that run the rsyslog service (optional)
{% if rsyslog_hosts_dict is defined and rsyslog_hosts_dict | length > 0 %}
log_hosts:
{% for h in rsyslog_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
{% endfor %}
{% endfor %}

# The Cinder storage LVM/iSCSI hosts
storage_hosts:
{% for h in storage_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
    container_vars:
      cinder_backends:
        limit_container_types: cinder_volume
        lvm:
          volume_backend_name: LVM_iSCSI
          volume_driver: cinder.volume.drivers.lvm.LVMVolumeDriver
          volume_group: cinder-volumes
          iscsi_ip_address: {{ h.ip_v4 }}
          lvm_type: thin
          extra_volume_types:
            - low-iops
            - high-iops
            - ultra-high-iops
{% endfor %}

# The hosts that run the Cinder API service
storage-infra_hosts:
{% for h in infrastructure_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
    container_vars:
      cinder_qos_specs:
        - name: low-iops
          options:
            consumer: front-end
            read_iops_sec: 75
            write_iops_sec: 75
          cinder_volume_types:
            - low-iops
        - name: high-iops
          options:
            consumer: front-end
            read_iops_sec: 150
            write_iops_sec: 150
          cinder_volume_types:
            - high-iops
        - name: ultra-high-iops
          options:
            consumer: front-end
            read_iops_sec: 300
            write_iops_sec: 300
          cinder_volume_types:
            - ultra-high-iops
{% endfor %}

##
## Infrastructure middleware
##

# The shared infrastructure software (MariaDB/Galera and RabbitMQ)
shared-infra_hosts: *infrastructure_hosts

# The OpenStack API services such as Nova API and Glance API
os-infra_hosts: *infrastructure_hosts

# OpenStack-Ansible repository cache (apt, python packages, etc)
repo-infra_hosts: *infrastructure_hosts

# When using HAProxy for load balancing, this tells the playbooks
# where to install and configure this service.
# Dedicated hardware is best for improved performance and security.
haproxy_hosts: *infrastructure_hosts

###
### OpenStack mandatory services
###

# The servers that run the Keystone (OpenStack Identity) Service
identity_hosts: *infrastructure_hosts

# Neutron L2/L3 agents and metadata services
network_hosts:
{% for h in network_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
{% endfor %}

# nova api services
compute-infra_hosts: *infrastructure_hosts

# The nodes that run the Horizon (OpenStack Dashboard) service
dashboard_hosts: *infrastructure_hosts

# The nodes that run the Glance (OpenStack Image) service
image_hosts:
{% for h in image_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
{% if 'ceph' not in onpc_services_list and 'swift' not in onpc_services_list %}
    container_vars:
      limit_container_types: glance
      glance_nfs_client:
        - server: {{ glance_nfs_store_host }}
          remote_path: /srv/nfs4/glance
          local_path: /var/lib/glance/images
          type: nfs
          options: "_netdev,auto"
{% endif %}
{% endfor %}

# The nodes that run the Neutron (OpenStack Networking) agents and services
# (neutron server, L3 agent, ...)
network_hosts:
{% for h in network_hosts_dict %}
  {{ h.name }}:
    ip: {{ h.ip_v4 }}
{% endfor %}
