---
# Copyright (c) 2018, OpenNext SAS
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# 
# In order to import a distribution, you will need a DVD ISO for your
# distribution. NOTE: You must use a full DVD, and not a "Live CD" ISO.
# For this example, we'll be using the CentOS 7 x86_64 ISO, available
# for download here.
# http://isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1810.iso
#
# Once this file is downloaded, mount it somewhere:
#
# $ mount -t iso9660 -o loop,ro /path/to/isos/CentOS-7-x86_64-DVD-1810.iso /mnt

pre_tasks:
  - assert:
    that: "{{ oncp_master_root_public_key | length > 0 }}" 
    msg: "user 'root' public key is undefined"

  - name: Create directory for ISOs download
    file:
      state: directory
      path: /var/tmp/isos

  - name: Check ISO not already downloaded
    stat:
      path: /var/tmp/isos/CentOS-7-x86_64-DVD-1810.iso
    register: result

  - name: Download distros ISOs
    url: "{{ item.url }}"
    dest: "/var/tmp/isos/{{ item.name }}"
    mode: 0440
    environment: "{{ onpc_proxy_environment| default('{}') }}"
    with_items:
      - name: CentOS-7-x86_64-DVD-1810.iso
        url: http://isoredirect.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-DVD-1810.iso
    when: result.stat.exists == false

roles:
  - role: ../roles/cobbler
    cobbler_default_password: to@change
    cobbler_server: 172.31.0.55
    cobbler_next_server: 172.31.0.55
    cobbler_subnet: 172.31.0.0
    cobbler_netmask: 255.255.255.0
    cobbler_dynamic_bootp_start: 172.31.0.60
    cobbler_dynamic_bootp_end: 172.31.0.70
    cobbler_routers: 172.31.0.254
    cobbler_domain_name_servers: 213.246.33.144,213.246.36.14
    cobbler_subnet_mask: 255.255.255.0
    cobbler_distros:
      - distro_name: CentOS-7
        device_or_iso_path: /var/tmp/isos/CentOS-7-x86_64-DVD-1810.iso
        arch: x86_64
        kickstart_file_name: centos7-customized-sda

    cobbler_install_web: true
    cobbler_web_user_pwd:
      - user_name: cobbler
        password: to!change
    cobbler_default_time_zone: "Europe/Paris"
    cobbler_root_public_keys:
      - "{{ oncp_master_root_public_key }}"


